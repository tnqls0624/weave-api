version: '3.8'

services:
  traefik:
    image: traefik:v2.10
    command:
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--providers.docker.swarmMode=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=weave-network"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--metrics.prometheus=true"
      - "--accesslog=false"
      - "--log.level=WARN"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - weave-network
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.dashboard.rule=Host(`traefik.weave.local`)"
        - "traefik.http.routers.dashboard.service=api@internal"
        - "traefik.http.services.dashboard.loadbalancer.server.port=8080"
    ports:
      - target: 80
        published: 80
        protocol: tcp
        mode: host
      - target: 443
        published: 443
        protocol: tcp
        mode: host
      - target: 8080
        published: 8081
        protocol: tcp
        mode: host

  mongodb:
    image: mongo:7.0
    command: mongod --wiredTigerCacheSizeGB 0.25 --quiet
    environment:
      - MONGO_INITDB_ROOT_USERNAME=root
      - MONGO_INITDB_ROOT_PASSWORD=${MONGODB_ROOT_PASSWORD}
      - MONGO_INITDB_DATABASE=lovechedule
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - weave-network
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: '0.5'
          memory: 384M
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 40s

  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD} --maxmemory 64mb --maxmemory-policy allkeys-lru --save ""
    volumes:
      - redis_data:/data
    networks:
      - weave-network
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: '0.25'
          memory: 80M
    healthcheck:
      test: [ "CMD", "redis-cli", "--raw", "incr", "ping" ]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 20s

  ml-trainer:
    image: ${ML_TRAINER_IMAGE}
    environment:
      # MongoDB 연결
      - MONGO_URI=${MONGODB_URI:-mongodb://root:1234@mongodb:27017/lovechedule?authSource=admin}

      # 재학습 설정
      - RETRAIN_DAYS=${ML_RETRAIN_DAYS:-30}
      - AUTO_DEPLOY=${ML_AUTO_DEPLOY:-true}

      # 실행 모드: cron (자동), once (일회성)
      - RUN_MODE=${ML_RUN_MODE:-cron}

      # Cron 스케줄 (기본: 매주 일요일 새벽 2시)
      - CRON_SCHEDULE=${ML_CRON_SCHEDULE:-0 2 * * 0}

      # Timezone
      - TZ=Asia/Seoul
    volumes:
      # 모델 파일 공유 (API 서버와 공유)
      - ml_models:/app/../models/phishing_detection_model

      # 학습 데이터 및 로그 영구 보존
      - ml_training_data:/app/training_data
      - ml_logs:/app/logs
      - ml_backups:/app/backups
    networks:
      - weave-network
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
        window: 300s
    depends_on:
      - mongodb
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  ml-inference:
    image: ${ML_INFERENCE_IMAGE}
    environment:
      - MODEL_PATH=/app/models/phishing_detection_model
      - PORT=8000
      - HOST=0.0.0.0
      - TZ=Asia/Seoul
    volumes:
      # 모델 파일 읽기 전용 (ML Trainer와 공유)
      - ml_models:/app/models/phishing_detection_model:ro
    networks:
      - weave-network
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: '0.5'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 512M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    ports:
      - "8000:8000"  # 개발용 (프로덕션에서는 제거 가능)

  api:
    image: ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}
    environment:
      # Spring Profile
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-prod}

      # MongoDB
      - SPRING_DATA_MONGODB_URI=${MONGODB_URI:-mongodb://root:1234@mongodb:27017/lovechedule?authSource=admin}
      - MONGODB_URI=${MONGODB_URI:-mongodb://root:1234@mongodb:27017/lovechedule?authSource=admin}

      # Redis
      - SPRING_DATA_REDIS_HOST=redis
      - SPRING_DATA_REDIS_PORT=6379
      - SPRING_DATA_REDIS_PASSWORD=${REDIS_PASSWORD}

      # JWT
      - JWT_EXPIRATION=${JWT_EXPIRATION:-31536000000}
      - JWT_REFRESH_EXPIRATION=${JWT_REFRESH_EXPIRATION:-31536000000}
      - JWT_PRIVATE_KEY_PATH=${JWT_PRIVATE_KEY_PATH:-}
      - JWT_PUBLIC_KEY_PATH=${JWT_PUBLIC_KEY_PATH:-}

      # Holiday API
      - HOLIDAY_API_SERVICE_KEY=${HOLIDAY_API_KEY}
      - HOLIDAY_API_BASE_URL=${HOLIDAY_API_BASE_URL:-https://apis.data.go.kr/B090041/openapi/service/SpcdeInfoService}

      # AWS S3
      - AWS_REGION=${AWS_REGION:-ap-northeast-2}
      - AWS_S3_BUCKET=${AWS_S3_BUCKET:-weave-file-bucket}
      - AWS_S3_PUBLIC_BASE_URL=${AWS_S3_PUBLIC_BASE_URL:-}
      - AWS_S3_UPLOAD_PREFIX=${AWS_S3_UPLOAD_PREFIX:-uploads/}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}

      - FIREBASE_CONFIG_PATH=${FIREBASE_CONFIG_PATH:-/app/keys/weave-75c40-firebase-adminsdk-fbsvc-ec0b3dc8b0.json}

      # ML Inference Server
      - PHISHING_ML_INFERENCE_URL=${PHISHING_ML_INFERENCE_URL:-http://ml-inference:8000}
      - PHISHING_ML_INFERENCE_ENABLED=${PHISHING_ML_INFERENCE_ENABLED:-true}

      # Timezone
      - TZ=Asia/Seoul

      # JVM 메모리 최적화
      - JAVA_TOOL_OPTIONS=-XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0 -XX:InitialRAMPercentage=50.0 -Xss256k -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+DisableExplicitGC
    volumes:
      - jwt_keys:/app/keys
      - /home/ec2-user/keys/weave-75c40-firebase-adminsdk-fbsvc-ec0b3dc8b0.json:/app/keys/weave-75c40-firebase-adminsdk-fbsvc-ec0b3dc8b0.json:ro
      # ML 모델 파일 (ML Trainer와 공유)
      - ml_models:/app/models/phishing_detection_model:ro
    networks:
      - weave-network
    deploy:
      mode: replicated
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 5s
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      labels:
        - "traefik.enable=true"
        # CORS 미들웨어 정의
        - "traefik.http.middlewares.api-cors.headers.accessControlAllowMethods=GET,POST,PUT,PATCH,DELETE,OPTIONS"
        - "traefik.http.middlewares.api-cors.headers.accessControlAllowOriginListRegex=.*"
        - "traefik.http.middlewares.api-cors.headers.accessControlAllowHeaders=*"
        - "traefik.http.middlewares.api-cors.headers.accessControlExposeHeaders=Authorization,Content-Type"
        - "traefik.http.middlewares.api-cors.headers.accessControlAllowCredentials=true"
        - "traefik.http.middlewares.api-cors.headers.accessControlMaxAge=3600"
        - "traefik.http.middlewares.api-cors.headers.addVaryHeader=true"
        # 서비스 정의 (공통)
        - "traefik.http.services.api.loadbalancer.server.port=8080"
        # WebSocket 라우팅 (CORS 미들웨어 없이, 우선순위 높게)
        - "traefik.http.routers.api-ws.rule=PathPrefix(`/api/ws`)"
        - "traefik.http.routers.api-ws.entrypoints=web"
        - "traefik.http.routers.api-ws.service=api"
        - "traefik.http.routers.api-ws.priority=100"
        # HTTP 라우팅 (CORS 미들웨어 적용)
        - "traefik.http.routers.api.rule=PathPrefix(`/api`) || PathPrefix(`/actuator`) || PathPrefix(`/swagger`) || PathPrefix(`/health`)"
        - "traefik.http.routers.api.entrypoints=web"
        - "traefik.http.routers.api.service=api"
        - "traefik.http.routers.api.middlewares=api-cors"
volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local
  redis_data:
    driver: local
  jwt_keys:
    driver: local
  # ML Training 관련 볼륨
  ml_models:
    driver: local
  ml_training_data:
    driver: local
  ml_logs:
    driver: local
  ml_backups:
    driver: local

networks:
  weave-network:
    driver: overlay
    attachable: true
