version: '3.8'

services:
  traefik:
    image: traefik:v2.10
    command:
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--providers.docker.swarmMode=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=weave-network"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--metrics.prometheus=true"
      - "--accesslog=true"
      - "--log.level=INFO"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - weave-network
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.dashboard.rule=Host(`traefik.weave.local`)"
        - "traefik.http.routers.dashboard.service=api@internal"
        - "traefik.http.services.dashboard.loadbalancer.server.port=8080"
    ports:
      - target: 80
        published: 80
        protocol: tcp
        mode: host
      - target: 443
        published: 443
        protocol: tcp
        mode: host
      - target: 8080
        published: 8081
        protocol: tcp
        mode: host

  mongodb:
    image: mongo:7.0
    environment:
      - MONGO_INITDB_ROOT_USERNAME=root
      - MONGO_INITDB_ROOT_PASSWORD=${MONGODB_ROOT_PASSWORD}
      - MONGO_INITDB_DATABASE=lovechedule
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - weave-network
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
    ports:
      - target: 27017
        published: 27017
        protocol: tcp
        mode: host
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    networks:
      - weave-network
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
    healthcheck:
      test: [ "CMD", "redis-cli", "--raw", "incr", "ping" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  api:
    image: ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}
    environment:
      # Spring Profile
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-prod}

      # MongoDB
      - SPRING_DATA_MONGODB_URI=${MONGODB_URI:-mongodb://root:1234@mongodb:27017/lovechedule?authSource=admin}
      - MONGODB_URI=${MONGODB_URI:-mongodb://root:1234@mongodb:27017/lovechedule?authSource=admin}

      # Redis
      - SPRING_DATA_REDIS_HOST=redis
      - SPRING_DATA_REDIS_PORT=6379
      - SPRING_DATA_REDIS_PASSWORD=${REDIS_PASSWORD}

      # JWT
      - JWT_EXPIRATION=${JWT_EXPIRATION:-31536000000}
      - JWT_REFRESH_EXPIRATION=${JWT_REFRESH_EXPIRATION:-31536000000}
      - JWT_PRIVATE_KEY_PATH=${JWT_PRIVATE_KEY_PATH:-}
      - JWT_PUBLIC_KEY_PATH=${JWT_PUBLIC_KEY_PATH:-}

      # Holiday API
      - HOLIDAY_API_SERVICE_KEY=${HOLIDAY_API_KEY}
      - HOLIDAY_API_BASE_URL=${HOLIDAY_API_BASE_URL:-https://apis.data.go.kr/B090041/openapi/service/SpcdeInfoService}

      # AWS S3
      - AWS_REGION=${AWS_REGION:-ap-northeast-2}
      - AWS_S3_BUCKET=${AWS_S3_BUCKET:-weave-file-bucket}
      - AWS_S3_PUBLIC_BASE_URL=${AWS_S3_PUBLIC_BASE_URL:-}
      - AWS_S3_UPLOAD_PREFIX=${AWS_S3_UPLOAD_PREFIX:-uploads/}

      # Firebase
      - FIREBASE_CONFIG_PATH=${FIREBASE_CONFIG_PATH:-weave-75c40-firebase-adminsdk-fbsvc-ec0b3dc8b0.json}

      # Timezone
      - TZ=Asia/Seoul
    volumes:
      - jwt_keys:/app/keys
    networks:
      - weave-network
    deploy:
      mode: replicated
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 5s
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      labels:
        - "traefik.enable=true"
        # CORS 미들웨어 정의
        - "traefik.http.middlewares.api-cors.headers.accessControlAllowMethods=GET,POST,PUT,PATCH,DELETE,OPTIONS"
        - "traefik.http.middlewares.api-cors.headers.accessControlAllowOriginListRegex=.*"
        - "traefik.http.middlewares.api-cors.headers.accessControlAllowHeaders=*"
        - "traefik.http.middlewares.api-cors.headers.accessControlExposeHeaders=Authorization,Content-Type"
        - "traefik.http.middlewares.api-cors.headers.accessControlAllowCredentials=true"
        - "traefik.http.middlewares.api-cors.headers.accessControlMaxAge=3600"
        - "traefik.http.middlewares.api-cors.headers.addVaryHeader=true"
        # 서비스 정의 (공통)
        - "traefik.http.services.api.loadbalancer.server.port=8080"
        # HTTP 라우팅 (CORS 미들웨어 적용)
        - "traefik.http.routers.api.rule=PathPrefix(`/`) || PathPrefix(`/api`) || PathPrefix(`/actuator`) || PathPrefix(`/swagger`) || PathPrefix(`/health`)"
        - "traefik.http.routers.api.entrypoints=web"
        - "traefik.http.routers.api.service=api"
        - "traefik.http.routers.api.middlewares=api-cors"
        # RSocket WebSocket 라우팅
        - "traefik.http.services.rsocket.loadbalancer.server.port=7070"
        - "traefik.http.routers.rsocket.rule=PathPrefix(`/api/rsocket`)"
        - "traefik.http.routers.rsocket.entrypoints=web"
        - "traefik.http.routers.rsocket.service=rsocket"

volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local
  redis_data:
    driver: local
  jwt_keys:
    driver: local

networks:
  weave-network:
    driver: overlay
    attachable: true
