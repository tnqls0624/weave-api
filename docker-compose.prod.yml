services:
  # ============================================
  # Docker Socket Proxy (보안 강화)
  # Traefik이 직접 Docker Socket에 접근하지 않도록 프록시 사용
  # ============================================
  docker-socket-proxy:
    image: tecnativa/docker-socket-proxy:latest
    environment:
      - CONTAINERS=1
      - SERVICES=1
      - TASKS=1
      - NETWORKS=1
      - NODES=1
      - INFO=1
      - VERSION=1
      - POST=0
      - BUILD=0
      - COMMIT=0
      - CONFIGS=0
      - DISTRIBUTION=0
      - EXEC=0
      - GRPC=0
      - IMAGES=0
      - PLUGINS=0
      - SECRETS=0
      - SESSION=0
      - SWARM=0
      - SYSTEM=0
      - VOLUMES=0
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - socket-proxy
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: '0.1'
          memory: 64M

  # ============================================
  # Traefik (Reverse Proxy & Load Balancer)
  # ============================================
  traefik:
    image: traefik:v2.10
    command:
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--providers.docker.swarmMode=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=weave-network"
      # Docker Socket Proxy 사용
      - "--providers.docker.endpoint=tcp://docker-socket-proxy:2375"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # 메트릭 활성화
      - "--metrics.prometheus=true"
      - "--metrics.prometheus.addEntryPointsLabels=true"
      - "--metrics.prometheus.addServicesLabels=true"
      - "--metrics.prometheus.buckets=0.1,0.3,1.2,5.0"
      # 접근 로그 활성화 (JSON 형식)
      - "--accesslog=true"
      - "--accesslog.format=json"
      - "--accesslog.fields.defaultmode=keep"
      - "--accesslog.fields.headers.defaultmode=keep"
      - "--log.level=INFO"
    networks:
      - weave-network
      - socket-proxy
    depends_on:
      - docker-socket-proxy
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.dashboard.rule=Host(`traefik.weave.local`)"
        - "traefik.http.routers.dashboard.service=api@internal"
        - "traefik.http.services.dashboard.loadbalancer.server.port=8080"
    ports:
      - target: 80
        published: 80
        protocol: tcp
        mode: host
      - target: 443
        published: 443
        protocol: tcp
        mode: host
      - target: 8080
        published: 8081
        protocol: tcp
        mode: host

  # ============================================
  # Loki (로그 수집)
  # ============================================
  loki:
    image: grafana/loki:2.9.0
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - loki_data:/loki
    networks:
      - weave-network
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3100/ready"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # Prometheus (메트릭 수집)
  # ============================================
  prometheus:
    image: prom/prometheus:v2.47.0
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'
      - '--web.enable-lifecycle'
    volumes:
      - prometheus_data:/prometheus
      - /home/ec2-user/monitoring/prometheus:/etc/prometheus:ro
    networks:
      - weave-network
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # AlertManager (알림 관리)
  # ============================================
  alertmanager:
    image: prom/alertmanager:v0.26.0
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
    volumes:
      - alertmanager_data:/alertmanager
      - /home/ec2-user/monitoring/alertmanager:/etc/alertmanager:ro
    networks:
      - weave-network
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: '0.1'
          memory: 64M

  # ============================================
  # Grafana (대시보드)
  # ============================================
  grafana:
    image: grafana/grafana:10.2.0
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=http://grafana.weave.local
      - GF_INSTALL_PLUGINS=grafana-piechart-panel
    volumes:
      - grafana_data:/var/lib/grafana
      - /home/ec2-user/monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
    networks:
      - weave-network
    depends_on:
      - prometheus
      - loki
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.grafana.rule=Host(`grafana.weave.local`)"
        - "traefik.http.routers.grafana.entrypoints=web"
        - "traefik.http.services.grafana.loadbalancer.server.port=3000"

  # ============================================
  # Jaeger (분산 트레이싱)
  # ============================================
  jaeger:
    image: jaegertracing/all-in-one:1.51
    environment:
      - COLLECTOR_OTLP_ENABLED=true
      - SPAN_STORAGE_TYPE=badger
      - BADGER_EPHEMERAL=false
      - BADGER_DIRECTORY_VALUE=/badger/data
      - BADGER_DIRECTORY_KEY=/badger/key
    volumes:
      - jaeger_data:/badger
    networks:
      - weave-network
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.jaeger.rule=Host(`jaeger.weave.local`)"
        - "traefik.http.routers.jaeger.entrypoints=web"
        - "traefik.http.services.jaeger.loadbalancer.server.port=16686"

  # ============================================
  # MongoDB
  # ============================================
  mongodb:
    image: mongo:7.0
    command: mongod --wiredTigerCacheSizeGB 0.25 --quiet
    environment:
      - MONGO_INITDB_ROOT_USERNAME=root
      - MONGO_INITDB_ROOT_PASSWORD=${MONGODB_ROOT_PASSWORD}
      - MONGO_INITDB_DATABASE=lovechedule
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - weave-network
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: '0.5'
          memory: 384M
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================
  # Redis
  # ============================================
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD} --maxmemory 64mb --maxmemory-policy allkeys-lru --save ""
    volumes:
      - redis_data:/data
    networks:
      - weave-network
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: '0.25'
          memory: 80M
    healthcheck:
      test: [ "CMD", "redis-cli", "--raw", "incr", "ping" ]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ============================================
  # API Application
  # ============================================
  api:
    image: ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}
    environment:
      # Spring Profile
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-prod}

      # MongoDB
      - SPRING_DATA_MONGODB_URI=${MONGODB_URI:-mongodb://root:1234@mongodb:27017/lovechedule?authSource=admin}
      - MONGODB_URI=${MONGODB_URI:-mongodb://root:1234@mongodb:27017/lovechedule?authSource=admin}

      # Redis
      - SPRING_DATA_REDIS_HOST=redis
      - SPRING_DATA_REDIS_PORT=6379
      - SPRING_DATA_REDIS_PASSWORD=${REDIS_PASSWORD}

      # JWT
      - JWT_EXPIRATION=${JWT_EXPIRATION:-31536000000}
      - JWT_REFRESH_EXPIRATION=${JWT_REFRESH_EXPIRATION:-31536000000}
      - JWT_PRIVATE_KEY_PATH=${JWT_PRIVATE_KEY_PATH:-}
      - JWT_PUBLIC_KEY_PATH=${JWT_PUBLIC_KEY_PATH:-}

      # Holiday API
      - HOLIDAY_API_SERVICE_KEY=${HOLIDAY_API_KEY}
      - HOLIDAY_API_BASE_URL=${HOLIDAY_API_BASE_URL:-https://apis.data.go.kr/B090041/openapi/service/SpcdeInfoService}

      # AWS S3
      - AWS_REGION=${AWS_REGION:-ap-northeast-2}
      - AWS_S3_BUCKET=${AWS_S3_BUCKET:-weave-file-bucket}
      - AWS_S3_PUBLIC_BASE_URL=${AWS_S3_PUBLIC_BASE_URL:-}
      - AWS_S3_UPLOAD_PREFIX=${AWS_S3_UPLOAD_PREFIX:-uploads/}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}

      - FIREBASE_CONFIG_PATH=${FIREBASE_CONFIG_PATH:-/app/keys/weave-75c40-firebase-adminsdk-fbsvc-ec0b3dc8b0.json}

      # Timezone
      - TZ=Asia/Seoul

      # JVM 메모리 최적화
      - JAVA_TOOL_OPTIONS=-XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0 -XX:InitialRAMPercentage=50.0 -Xss256k -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+DisableExplicitGC

      # Actuator & Monitoring
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,prometheus,metrics
      - MANAGEMENT_METRICS_EXPORT_PROMETHEUS_ENABLED=true
      - MANAGEMENT_METRICS_TAGS_APPLICATION=weave-api

      # OpenTelemetry (Jaeger)
      - OTEL_SERVICE_NAME=weave-api
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none
      - OTEL_LOGS_EXPORTER=none

    volumes:
      - jwt_keys:/app/keys
      - /home/ec2-user/keys/weave-75c40-firebase-adminsdk-fbsvc-ec0b3dc8b0.json:/app/keys/weave-75c40-firebase-adminsdk-fbsvc-ec0b3dc8b0.json:ro
    networks:
      - weave-network
    deploy:
      mode: replicated
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 5s
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
      labels:
        - "traefik.enable=true"
        # CORS 미들웨어 정의
        - "traefik.http.middlewares.api-cors.headers.accessControlAllowMethods=GET,POST,PUT,PATCH,DELETE,OPTIONS"
        - "traefik.http.middlewares.api-cors.headers.accessControlAllowOriginListRegex=.*"
        - "traefik.http.middlewares.api-cors.headers.accessControlAllowHeaders=*"
        - "traefik.http.middlewares.api-cors.headers.accessControlExposeHeaders=Authorization,Content-Type"
        - "traefik.http.middlewares.api-cors.headers.accessControlAllowCredentials=true"
        - "traefik.http.middlewares.api-cors.headers.accessControlMaxAge=3600"
        - "traefik.http.middlewares.api-cors.headers.addVaryHeader=true"
        # 서비스 정의 (공통)
        - "traefik.http.services.api.loadbalancer.server.port=8080"
        # WebSocket 라우팅 (CORS 미들웨어 없이, 우선순위 높게)
        - "traefik.http.routers.api-ws.rule=PathPrefix(`/api/ws`)"
        - "traefik.http.routers.api-ws.entrypoints=web"
        - "traefik.http.routers.api-ws.service=api"
        - "traefik.http.routers.api-ws.priority=100"
        # HTTP 라우팅 (CORS 미들웨어 적용)
        - "traefik.http.routers.api.rule=PathPrefix(`/api`) || PathPrefix(`/actuator`) || PathPrefix(`/swagger`) || PathPrefix(`/health`)"
        - "traefik.http.routers.api.entrypoints=web"
        - "traefik.http.routers.api.service=api"
        - "traefik.http.routers.api.middlewares=api-cors"

volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local
  redis_data:
    driver: local
  jwt_keys:
    driver: local
  loki_data:
    driver: local
  prometheus_data:
    driver: local
  alertmanager_data:
    driver: local
  grafana_data:
    driver: local
  jaeger_data:
    driver: local

networks:
  weave-network:
    driver: overlay
    attachable: true
  socket-proxy:
    driver: overlay
    internal: true
