services:
  # ============================================
  # Docker Socket Proxy (보안 강화)
  # Traefik이 직접 Docker Socket에 접근하지 않도록 프록시 사용
  # ============================================
  docker-socket-proxy:
    image: tecnativa/docker-socket-proxy:latest
    environment:
      - CONTAINERS=1
      - SERVICES=1
      - TASKS=1
      - NETWORKS=1
      - NODES=1
      - INFO=1
      - VERSION=1
      - POST=0
      - BUILD=0
      - COMMIT=0
      - CONFIGS=0
      - DISTRIBUTION=0
      - EXEC=0
      - GRPC=0
      - IMAGES=0
      - PLUGINS=0
      - SECRETS=0
      - SESSION=0
      - SWARM=0
      - SYSTEM=0
      - VOLUMES=0
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - socket-proxy
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 3
        window: 120s
      resources:
        limits:
          cpus: '0.1'
          memory: 64M

  # ============================================
  # Traefik (Reverse Proxy & Load Balancer)
  # ============================================
  traefik:
    image: traefik:v2.10
    command:
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--providers.docker.swarmMode=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=weave-network"
      # Docker Socket Proxy 사용
      - "--providers.docker.endpoint=tcp://docker-socket-proxy:2375"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # 메트릭 활성화 (외부 Prometheus에서 수집)
      - "--metrics.prometheus=true"
      - "--metrics.prometheus.addEntryPointsLabels=true"
      - "--metrics.prometheus.addServicesLabels=true"
      - "--metrics.prometheus.buckets=0.1,0.3,1.2,5.0"
      # 접근 로그 활성화 (JSON 형식)
      - "--accesslog=true"
      - "--accesslog.format=json"
      - "--accesslog.fields.defaultmode=keep"
      - "--accesslog.fields.headers.defaultmode=keep"
      - "--log.level=INFO"
    networks:
      - weave-network
      - socket-proxy
    depends_on:
      - docker-socket-proxy
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 3
        window: 120s
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.dashboard.rule=Host(`traefik.weave.local`)"
        - "traefik.http.routers.dashboard.service=api@internal"
        - "traefik.http.services.dashboard.loadbalancer.server.port=8080"
    ports:
      - target: 80
        published: 80
        protocol: tcp
        mode: host
      - target: 443
        published: 443
        protocol: tcp
        mode: host
      - target: 8080
        published: 8081
        protocol: tcp
        mode: host

  # ============================================
  # MongoDB
  # ============================================
  mongodb:
    image: mongo:7.0
    command: mongod --wiredTigerCacheSizeGB 0.25 --quiet
    environment:
      - MONGO_INITDB_ROOT_USERNAME=root
      - MONGO_INITDB_ROOT_PASSWORD=${MONGODB_ROOT_PASSWORD}
      - MONGO_INITDB_DATABASE=lovechedule
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - weave-network
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 3
        window: 120s
      resources:
        limits:
          cpus: '0.5'
          memory: 384M
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================
  # Redis
  # ============================================
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD} --maxmemory 64mb --maxmemory-policy allkeys-lru --save ""
    volumes:
      - redis_data:/data
    networks:
      - weave-network
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 3
        window: 120s
      resources:
        limits:
          cpus: '0.25'
          memory: 80M
    healthcheck:
      test: [ "CMD", "redis-cli", "--raw", "incr", "ping" ]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ============================================
  # API Application
  # ============================================
  api:
    image: ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}
    environment:
      # Spring Profile
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-prod}

      # MongoDB
      - SPRING_DATA_MONGODB_URI=${MONGODB_URI:-mongodb://root:1234@mongodb:27017/lovechedule?authSource=admin}
      - MONGODB_URI=${MONGODB_URI:-mongodb://root:1234@mongodb:27017/lovechedule?authSource=admin}

      # Redis
      - SPRING_DATA_REDIS_HOST=redis
      - SPRING_DATA_REDIS_PORT=6379
      - SPRING_DATA_REDIS_PASSWORD=${REDIS_PASSWORD}

      # JWT
      - JWT_EXPIRATION=${JWT_EXPIRATION:-31536000000}
      - JWT_REFRESH_EXPIRATION=${JWT_REFRESH_EXPIRATION:-31536000000}
      - JWT_PRIVATE_KEY_PATH=${JWT_PRIVATE_KEY_PATH:-}
      - JWT_PUBLIC_KEY_PATH=${JWT_PUBLIC_KEY_PATH:-}

      # Holiday API
      - HOLIDAY_API_SERVICE_KEY=${HOLIDAY_API_KEY}
      - HOLIDAY_API_BASE_URL=${HOLIDAY_API_BASE_URL:-https://apis.data.go.kr/B090041/openapi/service/SpcdeInfoService}

      # AWS S3
      - AWS_REGION=${AWS_REGION:-ap-northeast-2}
      - AWS_S3_BUCKET=${AWS_S3_BUCKET:-weave-file-bucket}
      - AWS_S3_PUBLIC_BASE_URL=${AWS_S3_PUBLIC_BASE_URL:-}
      - AWS_S3_UPLOAD_PREFIX=${AWS_S3_UPLOAD_PREFIX:-uploads/}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}

      - FIREBASE_CONFIG_PATH=${FIREBASE_CONFIG_PATH:-/app/keys/weave-75c40-firebase-adminsdk-fbsvc-ec0b3dc8b0.json}

      # Timezone
      - TZ=Asia/Seoul

      # JVM 메모리 최적화
      - JAVA_TOOL_OPTIONS=-XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0 -XX:InitialRAMPercentage=50.0 -Xss256k -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+DisableExplicitGC

      # Actuator & Monitoring (외부 Prometheus에서 수집)
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,prometheus,metrics
      - MANAGEMENT_METRICS_EXPORT_PROMETHEUS_ENABLED=true
      - MANAGEMENT_METRICS_TAGS_APPLICATION=weave-api

      # Loki (로그 수집 - 모니터링 서버 퍼블릭 IP)
      - LOKI_URL=${LOKI_URL:-http://43.201.42.89:3100}

    volumes:
      - jwt_keys:/app/keys
      - /home/ec2-user/keys/weave-75c40-firebase-adminsdk-fbsvc-ec0b3dc8b0.json:/app/keys/weave-75c40-firebase-adminsdk-fbsvc-ec0b3dc8b0.json:ro
    networks:
      - weave-network
    deploy:
      mode: replicated
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 5s
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 3
        window: 120s
      resources:
        limits:
          cpus: '1'
          memory: 768M
        reservations:
          cpus: '0.5'
          memory: 512M
      labels:
        - "traefik.enable=true"
        # CORS 미들웨어 정의
        - "traefik.http.middlewares.api-cors.headers.accessControlAllowMethods=GET,POST,PUT,PATCH,DELETE,OPTIONS"
        - "traefik.http.middlewares.api-cors.headers.accessControlAllowOriginListRegex=.*"
        - "traefik.http.middlewares.api-cors.headers.accessControlAllowHeaders=*"
        - "traefik.http.middlewares.api-cors.headers.accessControlExposeHeaders=Authorization,Content-Type"
        - "traefik.http.middlewares.api-cors.headers.accessControlAllowCredentials=true"
        - "traefik.http.middlewares.api-cors.headers.accessControlMaxAge=3600"
        - "traefik.http.middlewares.api-cors.headers.addVaryHeader=true"
        # 서비스 정의 (공통)
        - "traefik.http.services.api.loadbalancer.server.port=8080"
        # WebSocket 라우팅 (CORS 미들웨어 없이, 우선순위 높게)
        - "traefik.http.routers.api-ws.rule=PathPrefix(`/api/ws`)"
        - "traefik.http.routers.api-ws.entrypoints=web"
        - "traefik.http.routers.api-ws.service=api"
        - "traefik.http.routers.api-ws.priority=100"
        # Actuator 라우팅 (CORS 미들웨어 없이, 내부 헬스체크/모니터링용)
        - "traefik.http.routers.api-actuator.rule=PathPrefix(`/actuator`) || PathPrefix(`/health`)"
        - "traefik.http.routers.api-actuator.entrypoints=web"
        - "traefik.http.routers.api-actuator.service=api"
        - "traefik.http.routers.api-actuator.priority=90"
        # HTTP 라우팅 (CORS 미들웨어 적용)
        - "traefik.http.routers.api.rule=PathPrefix(`/api`) || PathPrefix(`/swagger`)"
        - "traefik.http.routers.api.entrypoints=web"
        - "traefik.http.routers.api.service=api"
        - "traefik.http.routers.api.middlewares=api-cors"

volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local
  redis_data:
    driver: local
  jwt_keys:
    driver: local

networks:
  weave-network:
    driver: overlay
    attachable: true
  socket-proxy:
    driver: overlay
    internal: true
