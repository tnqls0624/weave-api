name: Deploy to AWS EC2

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  AWS_REGION: ap-northeast-2
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-northeast-2.amazonaws.com

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set environment variables based on branch
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "ENVIRONMENT=production" >> $GITHUB_ENV
            echo "ECR_REPOSITORY=weave-api/prod" >> $GITHUB_ENV
            echo "APP_ENV=production" >> $GITHUB_ENV
            echo "APP_DEBUG=false" >> $GITHUB_ENV
            echo "LOG_LEVEL=error" >> $GITHUB_ENV
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        id: build-image
        run: |
          docker build --no-cache -t $ECR_REGISTRY/$ECR_REPOSITORY:$GITHUB_SHA .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$GITHUB_SHA
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$GITHUB_SHA $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$GITHUB_SHA" >> $GITHUB_OUTPUT

      - name: Prepare deployment files
        run: |
          mkdir -p deploy

          # í”„ë¡œë•ì…˜ Docker Compose íŒŒì¼ ë³µì‚¬
          cp docker-compose.prod.yml deploy/docker-compose.yml

          # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„±
          cat > deploy/.env << EOF
          ECR_REGISTRY=${{ env.ECR_REGISTRY }}
          ECR_REPOSITORY=${{ env.ECR_REPOSITORY }}
          IMAGE_TAG=${{ github.sha }}

          SPRING_PROFILES_ACTIVE=${{ env.APP_ENV }}

          # MongoDB
          MONGODB_URI=\${MONGODB_URI}
          MONGODB_ROOT_PASSWORD=\${MONGODB_ROOT_PASSWORD}

          # Redis
          REDIS_PASSWORD=\${REDIS_PASSWORD}

          # JWT
          JWT_EXPIRATION=\${JWT_EXPIRATION}
          JWT_REFRESH_EXPIRATION=\${JWT_REFRESH_EXPIRATION}
          JWT_PRIVATE_KEY_PATH=\${JWT_PRIVATE_KEY_PATH}
          JWT_PUBLIC_KEY_PATH=\${JWT_PUBLIC_KEY_PATH}

          # Holiday API
          HOLIDAY_API_KEY=\${HOLIDAY_API_KEY}
          HOLIDAY_API_BASE_URL=\${HOLIDAY_API_BASE_URL}

          # AWS S3
          AWS_REGION=\${AWS_REGION}
          AWS_S3_BUCKET=\${AWS_S3_BUCKET}
          AWS_S3_PUBLIC_BASE_URL=\${AWS_S3_PUBLIC_BASE_URL}
          AWS_S3_UPLOAD_PREFIX=\${AWS_S3_UPLOAD_PREFIX}

          # Firebase
          FIREBASE_CONFIG_PATH=\${FIREBASE_CONFIG_PATH}

          LOG_LEVEL=${{ env.LOG_LEVEL }}
          EOF

          # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
          cat > deploy/deploy.sh << 'EOF'
          #!/bin/bash
          set -e

          echo "=== Weave API ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ì‹œìž‘ ==="

          # .env íŒŒì¼ ë¡œë“œ
          if [ -f .env ]; then
            echo ".env íŒŒì¼ ë¡œë“œ ì¤‘..."
            set -a
            source .env
            set +a
            echo "í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ ì™„ë£Œ"
            echo "MONGODB_URI: [MASKED]"
            echo "ECR_REGISTRY: $ECR_REGISTRY"
          else
            echo "âŒ .env íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi

          # AWS CLI ì„¤ì • í™•ì¸
          echo "AWS CLI ë²„ì „ í™•ì¸ ì¤‘..."
          aws --version

          # docker-compose ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜
          if ! command -v docker-compose &> /dev/null; then
            echo "docker-compose ì„¤ì¹˜ ì¤‘..."
            sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
            echo "docker-compose ì„¤ì¹˜ ì™„ë£Œ"
          fi
          echo "docker-compose ë²„ì „: $(docker-compose --version)"

          # Docker Swarm ì´ˆê¸°í™” í™•ì¸
          echo "Docker Swarm ìƒíƒœ í™•ì¸ ì¤‘..."
          if ! docker info | grep -q "Swarm: active"; then
            echo "Docker Swarm ì´ˆê¸°í™” ì¤‘..."
            docker swarm init || true
          else
            echo "  - Docker Swarmì´ ì´ë¯¸ í™œì„±í™”ë˜ì–´ ìžˆìŠµë‹ˆë‹¤."
          fi

          # ECR ë¡œê·¸ì¸
          echo "ECR ë¡œê·¸ì¸ ì¤‘..."
          aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin $ECR_REGISTRY > /dev/null 2>&1

          # ì˜¤ë²„ë ˆì´ ë„¤íŠ¸ì›Œí¬ ìƒì„± (ì¡´ìž¬í•˜ì§€ ì•Šìœ¼ë©´)
          echo "ì˜¤ë²„ë ˆì´ ë„¤íŠ¸ì›Œí¬ í™•ì¸ ì¤‘..."
          if ! docker network ls | grep -q weave-network; then
            echo "  - weave-network ìƒì„± ì¤‘..."
            docker network create --driver overlay --attachable weave-network
          else
            echo "  - weave-networkê°€ ì´ë¯¸ ì¡´ìž¬í•©ë‹ˆë‹¤."
          fi

          # í™˜ê²½ ë³€ìˆ˜ í™•ì¸
          echo "í™˜ê²½ ë³€ìˆ˜ í™•ì¸:"
          echo "  ECR_REGISTRY: $ECR_REGISTRY"
          echo "  ECR_REPOSITORY: $ECR_REPOSITORY"
          echo "  IMAGE_TAG: $IMAGE_TAG"
          echo "  MONGODB_URI: [MASKED]"
          echo "  REDIS_PASSWORD: [MASKED]"

          # ìƒˆ ì´ë¯¸ì§€ í’€
          echo "ìƒˆ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘..."
          if [ -z "$ECR_REGISTRY" ] || [ -z "$ECR_REPOSITORY" ] || [ -z "$IMAGE_TAG" ]; then
            echo "âŒ í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 1
          fi

          # ìƒˆ ì´ë¯¸ì§€ pull (Dockerê°€ ìžë™ìœ¼ë¡œ ìµœì‹  ë ˆì´ì–´ë§Œ ë‹¤ìš´ë¡œë“œ)
          FULL_IMAGE=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker pull $FULL_IMAGE
          echo "  - ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ"

          # ì¸í”„ë¼ ì„œë¹„ìŠ¤ í™•ì¸ ë° ê°•ì œ ì—…ë°ì´íŠ¸ ì˜µì…˜
          echo "ì¸í”„ë¼ ì„œë¹„ìŠ¤ í™•ì¸ ì¤‘..."

          # Traefik í™•ì¸ ë° ì—…ë°ì´íŠ¸
          if ! docker service ls | grep -q weave_traefik; then
            echo "  - Traefik ìƒì„±"
            docker stack deploy -c docker-compose.yml weave --with-registry-auth
          elif [ "$FORCE_UPDATE_TRAEFIK" = "true" ]; then
            echo "  - Traefik ê°•ì œ ì—…ë°ì´íŠ¸"
            docker service update --force weave_traefik
          fi

          # MongoDB í™•ì¸ ë° ì—…ë°ì´íŠ¸
          if ! docker service ls | grep -q weave_mongodb; then
            echo "  - MongoDB ìƒì„±"
            docker stack deploy -c docker-compose.yml weave --with-registry-auth
          elif [ "$FORCE_UPDATE_MONGODB" = "true" ]; then
            echo "  - MongoDB ê°•ì œ ì—…ë°ì´íŠ¸ (ì´ë¯¸ì§€: mongo:7.0)"
            docker service update --image mongo:7.0 --force weave_mongodb
          fi

          # Redis í™•ì¸ ë° ì—…ë°ì´íŠ¸
          if ! docker service ls | grep -q weave_redis; then
            echo "  - Redis ìƒì„±"
            docker stack deploy -c docker-compose.yml weave --with-registry-auth
          elif [ "$FORCE_UPDATE_REDIS" = "true" ]; then
            echo "  - Redis ê°•ì œ ì—…ë°ì´íŠ¸"
            docker service update --force weave_redis
          fi

          # API ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸ (í•­ìƒ ìµœì‹  ì´ë¯¸ì§€ë¡œ)
          echo "API ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸ ì¤‘..."
          echo "  - ì´ë¯¸ì§€: $FULL_IMAGE"

          # ECR ìž¬ì¸ì¦ (ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸ ì§ì „)
          echo "  - ECR ìž¬ì¸ì¦ ì¤‘..."
          aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin $ECR_REGISTRY

          # docker stackìœ¼ë¡œ ì „ì²´ ìŠ¤íƒ ìž¬ë°°í¬ (í™˜ê²½ë³€ìˆ˜ ì—…ë°ì´íŠ¸ í¬í•¨)
          echo "  - Docker Stack ìž¬ë°°í¬ ì¤‘..."
          docker stack deploy -c docker-compose.yml weave --with-registry-auth --prune

          # ë°°í¬ ì™„ë£Œ ëŒ€ê¸°
          echo "ì„œë¹„ìŠ¤ ë°°í¬ ëŒ€ê¸° ì¤‘..."
          sleep 20

          # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
          echo "ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸:"
          docker service ls

          # API ì„œë¹„ìŠ¤ ìŠ¤ì¼€ì¼ë§ í™•ì¸
          echo "API ì„œë¹„ìŠ¤ ë ˆí”Œë¦¬ì¹´ ìƒíƒœ:"
          docker service ps weave_api --format "table {{.Name}}\t{{.CurrentState}}\t{{.Error}}"

          # API ì»¨í…Œì´ë„ˆê°€ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸°
          echo "API ì„œë¹„ìŠ¤ ì¤€ë¹„ ëŒ€ê¸° ì¤‘..."
          sleep 40

          echo ""
          echo "=== ë°°í¬ ì™„ë£Œ ==="
          echo ""
          echo "ì‹¤í–‰ ì¤‘ì¸ ì„œë¹„ìŠ¤:"
          docker service ls

          echo ""
          echo "API ë ˆí”Œë¦¬ì¹´ ìƒì„¸ ì •ë³´:"
          docker service ps weave_api --format "table {{.Name}}\t{{.Node}}\t{{.CurrentState}}"

          # ì´ë¯¸ì§€ ì •ë¦¬
          echo ""
          echo "ì˜¤ëž˜ëœ ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘..."
          OLD_IMAGES=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep "$ECR_REGISTRY/$ECR_REPOSITORY" | grep -v "latest" | grep -v "$IMAGE_TAG" || true)
          if [ ! -z "$OLD_IMAGES" ]; then
            echo "$OLD_IMAGES" | xargs -r docker rmi > /dev/null 2>&1 || true
            echo "  - ì˜¤ëž˜ëœ ì´ë¯¸ì§€ ì œê±° ì™„ë£Œ"
          else
            echo "  - ì œê±°í•  ì˜¤ëž˜ëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤."
          fi

          # ìµœì¢… ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰
          echo ""
          echo "ìµœì¢… ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰:"
          df -h / | tail -1 | awk '{print "  ì‚¬ìš©ëŸ‰: " $3 "/" $2 " (" $5 ")"}'

          echo ""
          echo "ðŸŽ‰ Docker Swarm ë°°í¬ ì™„ë£Œ!"
          echo "  - Traefik Dashboard: http://localhost:8081"
          echo "  - API Swagger: http://localhost/swagger"
          EOF

          chmod +x deploy/deploy.sh

      - name: Upload deployment files to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.ENVIRONMENT == 'production' && secrets.PROD_EC2_HOST || secrets.EC2_HOST }}
          username: ${{ env.ENVIRONMENT == 'production' && secrets.PROD_EC2_USER || secrets.EC2_USER }}
          key: ${{ env.ENVIRONMENT == 'production' && secrets.PROD_EC2_SSH_KEY || secrets.EC2_SSH_KEY }}
          port: 22
          source: "deploy/*"
          target: "~/deployment/"
          strip_components: 1

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.ENVIRONMENT == 'production' && secrets.PROD_EC2_HOST || secrets.EC2_HOST }}
          username: ${{ env.ENVIRONMENT == 'production' && secrets.PROD_EC2_USER || secrets.EC2_USER }}
          key: ${{ env.ENVIRONMENT == 'production' && secrets.PROD_EC2_SSH_KEY || secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            # í™˜ê²½ë³„ ë³€ìˆ˜ ì„¤ì •
            if [[ "${{ env.ENVIRONMENT }}" == "production" ]]; then

              # MongoDB
              MONGODB_URI="${{ secrets.PROD_SPRING_DATA_MONGODB_URI }}"
              MONGODB_ROOT_PASSWORD="${{ secrets.PROD_MONGODB_ROOT_PASSWORD }}"

              # Redis
              REDIS_PASSWORD="${{ secrets.PROD_REDIS_PASSWORD }}"

              # JWT
              JWT_EXPIRATION="${{ secrets.PROD_JWT_EXPIRATION }}"
              JWT_REFRESH_EXPIRATION="${{ secrets.PROD_JWT_REFRESH_EXPIRATION }}"
              JWT_PRIVATE_KEY_PATH="${{ secrets.PROD_JWT_PRIVATE_KEY_PATH }}"
              JWT_PUBLIC_KEY_PATH="${{ secrets.PROD_JWT_PUBLIC_KEY_PATH }}"

              # Holiday API
              HOLIDAY_API_KEY="${{ secrets.PROD_HOLIDAY_API_KEY }}"
              HOLIDAY_API_BASE_URL="${{ secrets.PROD_HOLIDAY_API_BASE_URL }}"

              # AWS
              AWS_REGION="${{ secrets.PROD_AWS_REGION }}"
              AWS_S3_BUCKET="${{ secrets.PROD_AWS_S3_BUCKET }}"
              AWS_S3_PUBLIC_BASE_URL="${{ secrets.PROD_AWS_S3_PUBLIC_BASE_URL }}"
              AWS_S3_UPLOAD_PREFIX="${{ secrets.PROD_AWS_S3_UPLOAD_PREFIX }}"
              AWS_ACCESS_KEY_ID="${{ secrets.PROD_AWS_ACCESS_KEY_ID }}"
              AWS_SECRET_ACCESS_KEY="${{ secrets.PROD_AWS_SECRET_ACCESS_KEY }}"

              # Firebase
              FIREBASE_CONFIG_PATH="${{ secrets.PROD_FIREBASE_CONFIG_PATH }}"
            else
              # ê°œë°œê³„ëŠ” ê¸°ì¡´ ì‹œí¬ë¦¿ ì‚¬ìš©

              # MongoDB
              MONGODB_URI="${{ secrets.SPRING_DATA_MONGODB_URI }}"
              MONGODB_ROOT_PASSWORD="${{ secrets.MONGODB_ROOT_PASSWORD }}"

              # Redis
              REDIS_PASSWORD="${{ secrets.REDIS_PASSWORD }}"

              # JWT
              JWT_EXPIRATION="${{ secrets.JWT_EXPIRATION }}"
              JWT_REFRESH_EXPIRATION="${{ secrets.JWT_REFRESH_EXPIRATION }}"
              JWT_PRIVATE_KEY_PATH="${{ secrets.JWT_PRIVATE_KEY_PATH }}"
              JWT_PUBLIC_KEY_PATH="${{ secrets.JWT_PUBLIC_KEY_PATH }}"

              # Holiday API
              HOLIDAY_API_KEY="${{ secrets.HOLIDAY_API_KEY }}"
              HOLIDAY_API_BASE_URL="${{ secrets.HOLIDAY_API_BASE_URL }}"

              # AWS
              AWS_REGION="${{ secrets.AWS_REGION }}"
              AWS_S3_BUCKET="${{ secrets.AWS_S3_BUCKET }}"
              AWS_S3_PUBLIC_BASE_URL="${{ secrets.AWS_S3_PUBLIC_BASE_URL }}"
              AWS_S3_UPLOAD_PREFIX="${{ secrets.AWS_S3_UPLOAD_PREFIX }}"

              # Firebase
              FIREBASE_CONFIG_PATH="${{ secrets.FIREBASE_CONFIG_PATH }}"
            fi

            # EC2ì—ì„œ ì§ì ‘ ë°°í¬ ì‹¤í–‰ (ë°°í¬ íŒŒì¼ì€ ì´ë¯¸ ì—…ë¡œë“œë¨)
            cd ~/deployment

            export ECR_REGISTRY=${{ env.ECR_REGISTRY }}
            export IMAGE_TAG=${{ github.sha }}
            export MONGODB_URI=${MONGODB_URI}
            export MONGODB_ROOT_PASSWORD=${MONGODB_ROOT_PASSWORD}
            export REDIS_PASSWORD=${REDIS_PASSWORD}
            export JWT_EXPIRATION=${JWT_EXPIRATION}
            export JWT_REFRESH_EXPIRATION=${JWT_REFRESH_EXPIRATION}
            export JWT_PRIVATE_KEY_PATH=${JWT_PRIVATE_KEY_PATH}
            export JWT_PUBLIC_KEY_PATH=${JWT_PUBLIC_KEY_PATH}
            export HOLIDAY_API_KEY=${HOLIDAY_API_KEY}
            export HOLIDAY_API_BASE_URL=${HOLIDAY_API_BASE_URL}
            export AWS_REGION=${AWS_REGION}
            export AWS_S3_BUCKET=${AWS_S3_BUCKET}
            export AWS_S3_PUBLIC_BASE_URL=${AWS_S3_PUBLIC_BASE_URL}
            export AWS_S3_UPLOAD_PREFIX=${AWS_S3_UPLOAD_PREFIX}
            export FIREBASE_CONFIG_PATH=${FIREBASE_CONFIG_PATH}
            export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
            export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}

            # .env íŒŒì¼ì—ëŠ” ë¯¼ê°í•˜ì§€ ì•Šì€ ì •ë³´ë§Œ ì €ìž¥ (ë¯¼ê° ì •ë³´ëŠ” í™˜ê²½ë³€ìˆ˜ë¡œë§Œ ì „ë‹¬)
            cat > .env << ENVEOF
            ECR_REGISTRY=${{ env.ECR_REGISTRY }}
            ECR_REPOSITORY=${{ env.ECR_REPOSITORY }}
            IMAGE_TAG=${{ github.sha }}
            SPRING_PROFILES_ACTIVE=prod
            MONGODB_URI=${MONGODB_URI}
            MONGODB_ROOT_PASSWORD=${MONGODB_ROOT_PASSWORD}
            REDIS_PASSWORD=${REDIS_PASSWORD}
            JWT_EXPIRATION=${JWT_EXPIRATION}
            JWT_REFRESH_EXPIRATION=${JWT_REFRESH_EXPIRATION}
            JWT_PRIVATE_KEY_PATH=${JWT_PRIVATE_KEY_PATH}
            JWT_PUBLIC_KEY_PATH=${JWT_PUBLIC_KEY_PATH}
            HOLIDAY_API_KEY=${HOLIDAY_API_KEY}
            HOLIDAY_API_BASE_URL=${HOLIDAY_API_BASE_URL}
            AWS_REGION=${AWS_REGION:-ap-northeast-2}
            AWS_S3_BUCKET=${AWS_S3_BUCKET}
            AWS_S3_PUBLIC_BASE_URL=${AWS_S3_PUBLIC_BASE_URL}
            AWS_S3_UPLOAD_PREFIX=${AWS_S3_UPLOAD_PREFIX:-uploads/}
            FIREBASE_CONFIG_PATH=${FIREBASE_CONFIG_PATH}
            FORCE_UPDATE_TRAEFIK=${{ secrets.FORCE_UPDATE_TRAEFIK }}
            FORCE_UPDATE_MONGODB=${{ secrets.FORCE_UPDATE_MONGODB }}
            FORCE_UPDATE_REDIS=${{ secrets.FORCE_UPDATE_REDIS }}
            
            ENVEOF

            # ë¯¼ê° ì •ë³´ëŠ” í™˜ê²½ë³€ìˆ˜ë¡œë§Œ ì „ë‹¬ (íŒŒì¼ì— ì €ìž¥ ì•ˆ í•¨)
            # deploy.shê°€ ì´ í™˜ê²½ë³€ìˆ˜ë“¤ì„ ì‚¬ìš©
            chmod +x deploy.sh
            ./deploy.sh
