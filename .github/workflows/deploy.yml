name: Deploy to AWS EC2

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  AWS_REGION: ap-northeast-2
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-northeast-2.amazonaws.com

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set environment variables based on branch
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "ENVIRONMENT=production" >> $GITHUB_ENV
            echo "ECR_REPOSITORY=weave-api/prod" >> $GITHUB_ENV
            echo "APP_ENV=production" >> $GITHUB_ENV
            echo "APP_DEBUG=false" >> $GITHUB_ENV
            echo "LOG_LEVEL=error" >> $GITHUB_ENV
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        id: build-image
        run: |
          docker build --no-cache -t $ECR_REGISTRY/$ECR_REPOSITORY:$GITHUB_SHA .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$GITHUB_SHA
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$GITHUB_SHA $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$GITHUB_SHA" >> $GITHUB_OUTPUT

      - name: Prepare deployment files
        run: |
          mkdir -p deploy

          # ÌîÑÎ°úÎçïÏÖò Docker Compose ÌååÏùº Î≥µÏÇ¨
          cp docker-compose.prod.yml deploy/docker-compose.yml

          # ÌôòÍ≤Ω Î≥ÄÏàò ÌååÏùº ÏÉùÏÑ±
          cat > deploy/.env << EOF
          ECR_REGISTRY=${{ env.ECR_REGISTRY }}
          ECR_REPOSITORY=${{ env.ECR_REPOSITORY }}
          IMAGE_TAG=${{ github.sha }}

          SPRING_PROFILES_ACTIVE=${{ env.APP_ENV }}

          # MongoDB
          MONGODB_URI=\${MONGODB_URI}
          MONGODB_ROOT_PASSWORD=\${MONGODB_ROOT_PASSWORD}

          # Redis
          REDIS_PASSWORD=\${REDIS_PASSWORD}

          # JWT
          JWT_EXPIRATION=\${JWT_EXPIRATION}
          JWT_REFRESH_EXPIRATION=\${JWT_REFRESH_EXPIRATION}
          JWT_PRIVATE_KEY_PATH=\${JWT_PRIVATE_KEY_PATH}
          JWT_PUBLIC_KEY_PATH=\${JWT_PUBLIC_KEY_PATH}

          # Holiday API
          HOLIDAY_API_KEY=\${HOLIDAY_API_KEY}
          HOLIDAY_API_BASE_URL=\${HOLIDAY_API_BASE_URL}

          # AWS S3
          AWS_REGION=\${AWS_REGION}
          AWS_S3_BUCKET=\${AWS_S3_BUCKET}
          AWS_S3_PUBLIC_BASE_URL=\${AWS_S3_PUBLIC_BASE_URL}
          AWS_S3_UPLOAD_PREFIX=\${AWS_S3_UPLOAD_PREFIX}

          # Firebase
          FIREBASE_CONFIG_PATH=\${FIREBASE_CONFIG_PATH}

          LOG_LEVEL=${{ env.LOG_LEVEL }}
          EOF

          # Î∞∞Ìè¨ Ïä§ÌÅ¨Î¶ΩÌä∏ ÏÉùÏÑ±
          cat > deploy/deploy.sh << 'EOF'
          #!/bin/bash
          set -e

          echo "=== Weave API Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò Î∞∞Ìè¨ ÏãúÏûë ==="

          # .env ÌååÏùº Î°úÎìú
          if [ -f .env ]; then
            echo ".env ÌååÏùº Î°úÎìú Ï§ë..."
            set -a
            source .env
            set +a
            echo "ÌôòÍ≤Ω Î≥ÄÏàò Î°úÎìú ÏôÑÎ£å"
            echo "MONGODB_URI: [MASKED]"
            echo "ECR_REGISTRY: $ECR_REGISTRY"
          else
            echo "‚ùå .env ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§."
            exit 1
          fi

          # AWS CLI ÏÑ§Ï†ï ÌôïÏù∏
          echo "AWS CLI Î≤ÑÏ†Ñ ÌôïÏù∏ Ï§ë..."
          aws --version

          # docker-compose ÏÑ§Ïπò ÌôïÏù∏ Î∞è ÏÑ§Ïπò
          if ! command -v docker-compose &> /dev/null; then
            echo "docker-compose ÏÑ§Ïπò Ï§ë..."
            sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
            echo "docker-compose ÏÑ§Ïπò ÏôÑÎ£å"
          fi
          echo "docker-compose Î≤ÑÏ†Ñ: $(docker-compose --version)"

          # Docker Swarm Ï¥àÍ∏∞Ìôî ÌôïÏù∏
          echo "Docker Swarm ÏÉÅÌÉú ÌôïÏù∏ Ï§ë..."
          if ! docker info | grep -q "Swarm: active"; then
            echo "Docker Swarm Ï¥àÍ∏∞Ìôî Ï§ë..."
            docker swarm init || true
          else
            echo "  - Docker SwarmÏù¥ Ïù¥ÎØ∏ ÌôúÏÑ±ÌôîÎêòÏñ¥ ÏûàÏäµÎãàÎã§."
          fi

          # ECR Î°úÍ∑∏Ïù∏
          echo "ECR Î°úÍ∑∏Ïù∏ Ï§ë..."
          aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin $ECR_REGISTRY > /dev/null 2>&1

          # Ïò§Î≤ÑÎ†àÏù¥ ÎÑ§Ìä∏ÏõåÌÅ¨ ÏÉùÏÑ± (Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏúºÎ©¥)
          echo "Ïò§Î≤ÑÎ†àÏù¥ ÎÑ§Ìä∏ÏõåÌÅ¨ ÌôïÏù∏ Ï§ë..."
          if ! docker network ls | grep -q weave-network; then
            echo "  - weave-network ÏÉùÏÑ± Ï§ë..."
            docker network create --driver overlay --attachable weave-network
          else
            echo "  - weave-networkÍ∞Ä Ïù¥ÎØ∏ Ï°¥Ïû¨Ìï©ÎãàÎã§."
          fi

          # ÌôòÍ≤Ω Î≥ÄÏàò ÌôïÏù∏
          echo "ÌôòÍ≤Ω Î≥ÄÏàò ÌôïÏù∏:"
          echo "  ECR_REGISTRY: $ECR_REGISTRY"
          echo "  ECR_REPOSITORY: $ECR_REPOSITORY"
          echo "  IMAGE_TAG: $IMAGE_TAG"
          echo "  MONGODB_URI: [MASKED]"
          echo "  REDIS_PASSWORD: [MASKED]"

          # ÏÉà Ïù¥ÎØ∏ÏßÄ ÌíÄ
          echo "ÏÉà Ïù¥ÎØ∏ÏßÄ Îã§Ïö¥Î°úÎìú Ï§ë..."
          if [ -z "$ECR_REGISTRY" ] || [ -z "$ECR_REPOSITORY" ] || [ -z "$IMAGE_TAG" ]; then
            echo "‚ùå ÌôòÍ≤Ω Î≥ÄÏàòÍ∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§."
            exit 1
          fi

          # ÏÉà Ïù¥ÎØ∏ÏßÄ pull (DockerÍ∞Ä ÏûêÎèôÏúºÎ°ú ÏµúÏã† Î†àÏù¥Ïñ¥Îßå Îã§Ïö¥Î°úÎìú)
          FULL_IMAGE=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker pull $FULL_IMAGE
          echo "  - Ïù¥ÎØ∏ÏßÄ Îã§Ïö¥Î°úÎìú ÏôÑÎ£å"

          # Ïù∏ÌîÑÎùº ÏÑúÎπÑÏä§ ÌôïÏù∏ Î∞è Í∞ïÏ†ú ÏóÖÎç∞Ïù¥Ìä∏ ÏòµÏÖò
          echo "Ïù∏ÌîÑÎùº ÏÑúÎπÑÏä§ ÌôïÏù∏ Ï§ë..."

          # Traefik ÌôïÏù∏ Î∞è ÏóÖÎç∞Ïù¥Ìä∏
          if ! docker service ls | grep -q weave_traefik; then
            echo "  - Traefik ÏÉùÏÑ±"
            docker stack deploy -c docker-compose.yml weave --with-registry-auth
          elif [ "$FORCE_UPDATE_TRAEFIK" = "true" ]; then
            echo "  - Traefik Í∞ïÏ†ú ÏóÖÎç∞Ïù¥Ìä∏"
            docker service update --force weave_traefik
          fi

          # MongoDB ÌôïÏù∏ Î∞è ÏóÖÎç∞Ïù¥Ìä∏
          if ! docker service ls | grep -q weave_mongodb; then
            echo "  - MongoDB ÏÉùÏÑ±"
            docker stack deploy -c docker-compose.yml weave --with-registry-auth
          elif [ "$FORCE_UPDATE_MONGODB" = "true" ]; then
            echo "  - MongoDB Í∞ïÏ†ú ÏóÖÎç∞Ïù¥Ìä∏ (Ïù¥ÎØ∏ÏßÄ: mongo:7.0)"
            docker service update --image mongo:7.0 --force weave_mongodb
          fi

          # Redis ÌôïÏù∏ Î∞è ÏóÖÎç∞Ïù¥Ìä∏
          if ! docker service ls | grep -q weave_redis; then
            echo "  - Redis ÏÉùÏÑ±"
            docker stack deploy -c docker-compose.yml weave --with-registry-auth
          elif [ "$FORCE_UPDATE_REDIS" = "true" ]; then
            echo "  - Redis Í∞ïÏ†ú ÏóÖÎç∞Ïù¥Ìä∏"
            docker service update --force weave_redis
          fi

          # API ÏÑúÎπÑÏä§ ÏóÖÎç∞Ïù¥Ìä∏ (Ìï≠ÏÉÅ ÏµúÏã† Ïù¥ÎØ∏ÏßÄÎ°ú)
          echo "API ÏÑúÎπÑÏä§ ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë..."
          echo "  - Ïù¥ÎØ∏ÏßÄ: $FULL_IMAGE"

          # ECR Ïû¨Ïù∏Ï¶ù (ÏÑúÎπÑÏä§ ÏóÖÎç∞Ïù¥Ìä∏ ÏßÅÏ†Ñ)
          echo "  - ECR Ïû¨Ïù∏Ï¶ù Ï§ë..."
          aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin $ECR_REGISTRY

          # docker stackÏúºÎ°ú Ï†ÑÏ≤¥ Ïä§ÌÉù Ïû¨Î∞∞Ìè¨ (ÌôòÍ≤ΩÎ≥ÄÏàò ÏóÖÎç∞Ïù¥Ìä∏ Ìè¨Ìï®)
          echo "  - Docker Stack Ïû¨Î∞∞Ìè¨ Ï§ë..."
          docker stack deploy -c docker-compose.yml weave --with-registry-auth --prune

          # Î∞∞Ìè¨ ÏôÑÎ£å ÎåÄÍ∏∞
          echo "ÏÑúÎπÑÏä§ Î∞∞Ìè¨ ÎåÄÍ∏∞ Ï§ë..."
          sleep 20

          # ÏÑúÎπÑÏä§ ÏÉÅÌÉú ÌôïÏù∏
          echo "ÏÑúÎπÑÏä§ ÏÉÅÌÉú ÌôïÏù∏:"
          docker service ls

          # API ÏÑúÎπÑÏä§ Ïä§ÏºÄÏùºÎßÅ ÌôïÏù∏
          echo "API ÏÑúÎπÑÏä§ Î†àÌîåÎ¶¨Ïπ¥ ÏÉÅÌÉú:"
          docker service ps weave_api --format "table {{.Name}}\t{{.CurrentState}}\t{{.Error}}"

          # API Ïª®ÌÖåÏù¥ÎÑàÍ∞Ä Ï§ÄÎπÑÎê† ÎïåÍπåÏßÄ ÎåÄÍ∏∞
          echo "API ÏÑúÎπÑÏä§ Ï§ÄÎπÑ ÎåÄÍ∏∞ Ï§ë..."
          sleep 40

          echo ""
          echo "=== Î∞∞Ìè¨ ÏôÑÎ£å ==="
          echo ""
          echo "Ïã§Ìñâ Ï§ëÏù∏ ÏÑúÎπÑÏä§:"
          docker service ls

          echo ""
          echo "API Î†àÌîåÎ¶¨Ïπ¥ ÏÉÅÏÑ∏ Ï†ïÎ≥¥:"
          docker service ps weave_api --format "table {{.Name}}\t{{.Node}}\t{{.CurrentState}}"

          # Ïù¥ÎØ∏ÏßÄ Ï†ïÎ¶¨
          echo ""
          echo "Ïò§ÎûòÎêú Ïù¥ÎØ∏ÏßÄ Ï†ïÎ¶¨ Ï§ë..."
          OLD_IMAGES=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep "$ECR_REGISTRY/$ECR_REPOSITORY" | grep -v "latest" | grep -v "$IMAGE_TAG" || true)
          if [ ! -z "$OLD_IMAGES" ]; then
            echo "$OLD_IMAGES" | xargs -r docker rmi > /dev/null 2>&1 || true
            echo "  - Ïò§ÎûòÎêú Ïù¥ÎØ∏ÏßÄ Ï†úÍ±∞ ÏôÑÎ£å"
          else
            echo "  - Ï†úÍ±∞Ìï† Ïò§ÎûòÎêú Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§."
          fi

          # ÏµúÏ¢Ö ÎîîÏä§ÌÅ¨ ÏÇ¨Ïö©Îüâ
          echo ""
          echo "ÏµúÏ¢Ö ÎîîÏä§ÌÅ¨ ÏÇ¨Ïö©Îüâ:"
          df -h / | tail -1 | awk '{print "  ÏÇ¨Ïö©Îüâ: " $3 "/" $2 " (" $5 ")"}'

          echo ""
          echo "üéâ Docker Swarm Î∞∞Ìè¨ ÏôÑÎ£å!"
          echo "  - Traefik Dashboard: http://localhost:8081"
          echo "  - API Swagger: http://localhost/swagger"
          EOF

          chmod +x deploy/deploy.sh

      - name: Upload deployment files to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.ENVIRONMENT == 'production' && secrets.PROD_EC2_HOST || secrets.EC2_HOST }}
          username: ${{ env.ENVIRONMENT == 'production' && secrets.PROD_EC2_USER || secrets.EC2_USER }}
          key: ${{ env.ENVIRONMENT == 'production' && secrets.PROD_EC2_SSH_KEY || secrets.EC2_SSH_KEY }}
          port: 22
          source: "deploy/*"
          target: "~/deployment/"
          strip_components: 1

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.ENVIRONMENT == 'production' && secrets.PROD_EC2_HOST || secrets.EC2_HOST }}
          username: ${{ env.ENVIRONMENT == 'production' && secrets.PROD_EC2_USER || secrets.EC2_USER }}
          key: ${{ env.ENVIRONMENT == 'production' && secrets.PROD_EC2_SSH_KEY || secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            # ÌôòÍ≤ΩÎ≥Ñ Î≥ÄÏàò ÏÑ§Ï†ï
            # MongoDB
            MONGODB_URI="${{ secrets.PROD_SPRING_DATA_MONGODB_URI }}"
            MONGODB_ROOT_PASSWORD="${{ secrets.PROD_MONGODB_ROOT_PASSWORD }}"

            # Redis
            REDIS_PASSWORD="${{ secrets.PROD_REDIS_PASSWORD }}"

            # JWT
            JWT_EXPIRATION="${{ secrets.PROD_JWT_EXPIRATION }}"
            JWT_REFRESH_EXPIRATION="${{ secrets.PROD_JWT_REFRESH_EXPIRATION }}"
            JWT_PRIVATE_KEY_PATH="${{ secrets.PROD_JWT_PRIVATE_KEY_PATH }}"
            JWT_PUBLIC_KEY_PATH="${{ secrets.PROD_JWT_PUBLIC_KEY_PATH }}"

            # Holiday API
            HOLIDAY_API_KEY="${{ secrets.PROD_HOLIDAY_API_KEY }}"
            HOLIDAY_API_BASE_URL="${{ secrets.PROD_HOLIDAY_API_BASE_URL }}"

            # AWS
            AWS_REGION="${{ secrets.PROD_AWS_REGION }}"
            AWS_S3_BUCKET="${{ secrets.PROD_AWS_S3_BUCKET }}"
            AWS_S3_PUBLIC_BASE_URL="${{ secrets.PROD_AWS_S3_PUBLIC_BASE_URL }}"
            AWS_S3_UPLOAD_PREFIX="${{ secrets.PROD_AWS_S3_UPLOAD_PREFIX }}"
            AWS_ACCESS_KEY_ID="${{ secrets.PROD_AWS_ACCESS_KEY_ID }}"
            AWS_SECRET_ACCESS_KEY="${{ secrets.PROD_AWS_SECRET_ACCESS_KEY }}"

            # EC2ÏóêÏÑú ÏßÅÏ†ë Î∞∞Ìè¨ Ïã§Ìñâ (Î∞∞Ìè¨ ÌååÏùºÏùÄ Ïù¥ÎØ∏ ÏóÖÎ°úÎìúÎê®)
            cd ~/deployment

            export ECR_REGISTRY=${{ env.ECR_REGISTRY }}
            export IMAGE_TAG=${{ github.sha }}
            export MONGODB_URI=${MONGODB_URI}
            export MONGODB_ROOT_PASSWORD=${MONGODB_ROOT_PASSWORD}
            export REDIS_PASSWORD=${REDIS_PASSWORD}
            export JWT_EXPIRATION=${JWT_EXPIRATION}
            export JWT_REFRESH_EXPIRATION=${JWT_REFRESH_EXPIRATION}
            export JWT_PRIVATE_KEY_PATH=${JWT_PRIVATE_KEY_PATH}
            export JWT_PUBLIC_KEY_PATH=${JWT_PUBLIC_KEY_PATH}
            export HOLIDAY_API_KEY=${HOLIDAY_API_KEY}
            export HOLIDAY_API_BASE_URL=${HOLIDAY_API_BASE_URL}
            export AWS_REGION=${AWS_REGION}
            export AWS_S3_BUCKET=${AWS_S3_BUCKET}
            export AWS_S3_PUBLIC_BASE_URL=${AWS_S3_PUBLIC_BASE_URL}
            export AWS_S3_UPLOAD_PREFIX=${AWS_S3_UPLOAD_PREFIX}
            export FIREBASE_CONFIG_PATH=${FIREBASE_CONFIG_PATH}
            export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
            export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}

            chmod +x deploy.sh
            ./deploy.sh
