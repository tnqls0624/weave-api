name: Deploy to AWS EC2

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  AWS_REGION: ap-northeast-2
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-northeast-2.amazonaws.com

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set environment variables based on branch
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "ENVIRONMENT=production" >> $GITHUB_ENV
            echo "ECR_REPOSITORY=weave-api/prod" >> $GITHUB_ENV
            echo "APP_ENV=production" >> $GITHUB_ENV
            echo "APP_DEBUG=false" >> $GITHUB_ENV
            echo "LOG_LEVEL=error" >> $GITHUB_ENV
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        id: build-image
        run: |
          docker build --no-cache -t $ECR_REGISTRY/$ECR_REPOSITORY:$GITHUB_SHA .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$GITHUB_SHA
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$GITHUB_SHA $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$GITHUB_SHA" >> $GITHUB_OUTPUT

      - name: Prepare deployment files
        run: |
          mkdir -p deploy

          # ÌîÑÎ°úÎçïÏÖò Docker Compose ÌååÏùº Î≥µÏÇ¨
          cp docker-compose.prod.yml deploy/docker-compose.yml

          # ÌôòÍ≤Ω Î≥ÄÏàò ÌååÏùº ÏÉùÏÑ±
          cat > deploy/.env << EOF
          ECR_REGISTRY=${{ env.ECR_REGISTRY }}
          ECR_REPOSITORY=${{ env.ECR_REPOSITORY }}
          IMAGE_TAG=${{ github.sha }}

          SPRING_PROFILES_ACTIVE=${{ env.APP_ENV }}

          # MongoDB
          SPRING_DATA_MONGODB_URI=\${SPRING_DATA_MONGODB_URI}
          MONGODB_ROOT_PASSWORD=\${MONGODB_ROOT_PASSWORD}

          # Redis
          REDIS_PASSWORD=\${REDIS_PASSWORD}

          # JWT
          JWT_EXPIRATION=\${JWT_EXPIRATION}
          JWT_REFRESH_EXPIRATION=\${JWT_REFRESH_EXPIRATION}
          JWT_PRIVATE_KEY_PATH=\${JWT_PRIVATE_KEY_PATH}
          JWT_PUBLIC_KEY_PATH=\${JWT_PUBLIC_KEY_PATH}

          # OAuth - Kakao
          KAKAO_CLIENT_ID=\${KAKAO_CLIENT_ID}
          KAKAO_CLIENT_SECRET=\${KAKAO_CLIENT_SECRET}
          KAKAO_REDIRECT_URI=\${KAKAO_REDIRECT_URI}

          # OAuth - Google
          GOOGLE_CLIENT_ID=\${GOOGLE_CLIENT_ID}
          GOOGLE_CLIENT_SECRET=\${GOOGLE_CLIENT_SECRET}
          GOOGLE_REDIRECT_URI=\${GOOGLE_REDIRECT_URI}

          # Holiday API
          HOLIDAY_API_KEY=\${HOLIDAY_API_KEY}
          HOLIDAY_API_BASE_URL=\${HOLIDAY_API_BASE_URL}

          # AWS S3
          AWS_REGION=\${AWS_REGION}
          AWS_S3_BUCKET=\${AWS_S3_BUCKET}
          AWS_S3_PUBLIC_BASE_URL=\${AWS_S3_PUBLIC_BASE_URL}
          AWS_S3_UPLOAD_PREFIX=\${AWS_S3_UPLOAD_PREFIX}

          # Firebase
          FIREBASE_CONFIG_PATH=\${FIREBASE_CONFIG_PATH}

          # Server
          PORT=\${PORT}

          LOG_LEVEL=${{ env.LOG_LEVEL }}
          EOF

          # Î∞∞Ìè¨ Ïä§ÌÅ¨Î¶ΩÌä∏ ÏÉùÏÑ±
          cat > deploy/deploy.sh << 'EOF'
          #!/bin/bash
          set -e

          echo "=== Weave API Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò Î∞∞Ìè¨ ÏãúÏûë (${{ env.ENVIRONMENT }}) ==="

          # AWS CLI ÏÑ§Ï†ï ÌôïÏù∏
          echo "AWS CLI Î≤ÑÏ†Ñ ÌôïÏù∏ Ï§ë..."
          aws --version

          # docker-compose ÏÑ§Ïπò ÌôïÏù∏ Î∞è ÏÑ§Ïπò
          if ! command -v docker-compose &> /dev/null; then
            echo "docker-compose ÏÑ§Ïπò Ï§ë..."
            sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
            echo "docker-compose ÏÑ§Ïπò ÏôÑÎ£å"
          fi
          echo "docker-compose Î≤ÑÏ†Ñ: $(docker-compose --version)"

          # Docker Swarm Ï¥àÍ∏∞Ìôî ÌôïÏù∏
          echo "Docker Swarm ÏÉÅÌÉú ÌôïÏù∏ Ï§ë..."
          if ! docker info | grep -q "Swarm: active"; then
            echo "Docker Swarm Ï¥àÍ∏∞Ìôî Ï§ë..."
            docker swarm init || true
          else
            echo "  - Docker SwarmÏù¥ Ïù¥ÎØ∏ ÌôúÏÑ±ÌôîÎêòÏñ¥ ÏûàÏäµÎãàÎã§."
          fi

          # ECR Î°úÍ∑∏Ïù∏
          echo "ECR Î°úÍ∑∏Ïù∏ Ï§ë..."
          aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin $ECR_REGISTRY > /dev/null 2>&1

          # Ïò§Î≤ÑÎ†àÏù¥ ÎÑ§Ìä∏ÏõåÌÅ¨ ÏÉùÏÑ± (Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏúºÎ©¥)
          echo "Ïò§Î≤ÑÎ†àÏù¥ ÎÑ§Ìä∏ÏõåÌÅ¨ ÌôïÏù∏ Ï§ë..."
          if ! docker network ls | grep -q weave-network; then
            echo "  - weave-network ÏÉùÏÑ± Ï§ë..."
            docker network create --driver overlay --attachable weave-network
          else
            echo "  - weave-networkÍ∞Ä Ïù¥ÎØ∏ Ï°¥Ïû¨Ìï©ÎãàÎã§."
          fi

          # ÏÉà Ïù¥ÎØ∏ÏßÄ ÌíÄ
          echo "ÏÉà Ïù¥ÎØ∏ÏßÄ Îã§Ïö¥Î°úÎìú Ï§ë..."
          docker pull $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          echo "  - Ïù¥ÎØ∏ÏßÄ Îã§Ïö¥Î°úÎìú ÏôÑÎ£å"

          # Docker Stack Î∞∞Ìè¨ (Rolling Update)
          echo "Docker Stack Î∞∞Ìè¨ Ï§ë..."
          docker stack deploy -c docker-compose.yml weave --with-registry-auth

          # Î∞∞Ìè¨ ÏôÑÎ£å ÎåÄÍ∏∞
          echo "ÏÑúÎπÑÏä§ Î∞∞Ìè¨ ÎåÄÍ∏∞ Ï§ë..."
          sleep 20

          # ÏÑúÎπÑÏä§ ÏÉÅÌÉú ÌôïÏù∏
          echo "ÏÑúÎπÑÏä§ ÏÉÅÌÉú ÌôïÏù∏:"
          docker service ls

          # API ÏÑúÎπÑÏä§ Ïä§ÏºÄÏùºÎßÅ ÌôïÏù∏
          echo "API ÏÑúÎπÑÏä§ Î†àÌîåÎ¶¨Ïπ¥ ÏÉÅÌÉú:"
          docker service ps weave_api --format "table {{.Name}}\t{{.CurrentState}}\t{{.Error}}"

          # API Ïª®ÌÖåÏù¥ÎÑàÍ∞Ä Ï§ÄÎπÑÎê† ÎïåÍπåÏßÄ ÎåÄÍ∏∞
          echo "API ÏÑúÎπÑÏä§ Ï§ÄÎπÑ ÎåÄÍ∏∞ Ï§ë..."
          sleep 40

          # Ìó¨Ïä§ Ï≤¥ÌÅ¨
          echo "Ìó¨Ïä§ Ï≤¥ÌÅ¨ ÏàòÌñâ Ï§ë..."
          sleep 10

          # TraefikÏùÑ ÌÜµÌïú API ÏÑúÎπÑÏä§ Ìó¨Ïä§ Ï≤¥ÌÅ¨
          if curl -f http://localhost/actuator/health > /dev/null 2>&1; then
              echo "‚úÖ API ÏÑúÎπÑÏä§ Ï†ïÏÉÅ ÏûëÎèô (Traefik Í≤ΩÏú†)"
          else
              echo "‚ùå API ÏÑúÎπÑÏä§ Ìó¨Ïä§ Ï≤¥ÌÅ¨ Ïã§Ìå®"
              echo "ÏÑúÎπÑÏä§ ÏÉÅÌÉú:"
              docker service ps weave_api --no-trunc
              echo ""
              echo "API ÏÑúÎπÑÏä§ Î°úÍ∑∏:"
              docker service logs weave_api --tail=30
              exit 1
          fi

          echo ""
          echo "=== ${{ env.ENVIRONMENT }} ÌôòÍ≤Ω Î∞∞Ìè¨ ÏôÑÎ£å ==="
          echo ""
          echo "Ïã§Ìñâ Ï§ëÏù∏ ÏÑúÎπÑÏä§:"
          docker service ls

          echo ""
          echo "API Î†àÌîåÎ¶¨Ïπ¥ ÏÉÅÏÑ∏ Ï†ïÎ≥¥:"
          docker service ps weave_api --format "table {{.Name}}\t{{.Node}}\t{{.CurrentState}}"

          # Ïù¥ÎØ∏ÏßÄ Ï†ïÎ¶¨
          echo ""
          echo "Ïò§ÎûòÎêú Ïù¥ÎØ∏ÏßÄ Ï†ïÎ¶¨ Ï§ë..."
          OLD_IMAGES=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep "$ECR_REGISTRY/$ECR_REPOSITORY" | grep -v "latest" | grep -v "$IMAGE_TAG" || true)
          if [ ! -z "$OLD_IMAGES" ]; then
            echo "$OLD_IMAGES" | xargs -r docker rmi > /dev/null 2>&1 || true
            echo "  - Ïò§ÎûòÎêú Ïù¥ÎØ∏ÏßÄ Ï†úÍ±∞ ÏôÑÎ£å"
          else
            echo "  - Ï†úÍ±∞Ìï† Ïò§ÎûòÎêú Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§."
          fi

          # ÏµúÏ¢Ö ÎîîÏä§ÌÅ¨ ÏÇ¨Ïö©Îüâ
          echo ""
          echo "ÏµúÏ¢Ö ÎîîÏä§ÌÅ¨ ÏÇ¨Ïö©Îüâ:"
          df -h / | tail -1 | awk '{print "  ÏÇ¨Ïö©Îüâ: " $3 "/" $2 " (" $5 ")"}'

          echo ""
          echo "üéâ Docker Swarm Î∞∞Ìè¨ ÏôÑÎ£å!"
          echo "  - Traefik Dashboard: http://localhost:8081"
          echo "  - API Health: http://localhost/actuator/health"
          echo "  - API Swagger: http://localhost/swagger"
          EOF

          chmod +x deploy/deploy.sh

      - name: Create SSH directory and key file
        run: |
          mkdir -p ~/.ssh
          if [[ "${{ env.ENVIRONMENT }}" == "production" ]]; then
            echo "${{ secrets.PROD_BASTION_SSH_KEY }}" > ~/.ssh/weave-prd-bastion-key.pem
            echo "${{ secrets.PROD_PRIVATE_EC2_SSH_KEY }}" > ~/.ssh/weave-prd-private-key.pem
          else
            # Í∞úÎ∞úÍ≥ÑÎäî Í∏∞Ï°¥ ÏãúÌÅ¨Î¶ø ÏÇ¨Ïö©
            echo "${{ secrets.BASTION_SSH_KEY }}" > ~/.ssh/weave-dev-bastion-key.pem
            echo "${{ secrets.PRIVATE_EC2_SSH_KEY }}" > ~/.ssh/weave-dev-private-key.pem
          fi
          chmod 600 ~/.ssh/weave-*-bastion-key.pem
          chmod 600 ~/.ssh/weave-*-private-key.pem
          ls -la ~/.ssh/

      - name: Upload deployment files to Bastion
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.ENVIRONMENT == 'production' && secrets.PROD_BASTION_HOST || secrets.BASTION_HOST }}
          username: ${{ env.ENVIRONMENT == 'production' && secrets.PROD_BASTION_USER || secrets.BASTION_USER }}
          key: ${{ env.ENVIRONMENT == 'production' && secrets.PROD_BASTION_SSH_KEY || secrets.BASTION_SSH_KEY }}
          port: 22
          source: "deploy/*"
          target: "~/deployment/"
          strip_components: 1

      - name: Deploy to EC2 via Bastion Host
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.ENVIRONMENT == 'production' && secrets.PROD_BASTION_HOST || secrets.BASTION_HOST }}
          username: ${{ env.ENVIRONMENT == 'production' && secrets.PROD_BASTION_USER || secrets.BASTION_USER }}
          key: ${{ env.ENVIRONMENT == 'production' && secrets.PROD_BASTION_SSH_KEY || secrets.BASTION_SSH_KEY }}
          port: 22
          script: |
            # ÌôòÍ≤ΩÎ≥Ñ Î≥ÄÏàò ÏÑ§Ï†ï
            if [[ "${{ env.ENVIRONMENT }}" == "production" ]]; then
              PRIVATE_EC2_HOST="${{ secrets.PROD_PRIVATE_EC2_HOST }}"
              PRIVATE_EC2_USER="${{ secrets.PROD_PRIVATE_EC2_USER }}"

              # MongoDB
              SPRING_DATA_MONGODB_URI="${{ secrets.PROD_SPRING_DATA_MONGODB_URI }}"
              MONGODB_ROOT_PASSWORD="${{ secrets.PROD_MONGODB_ROOT_PASSWORD }}"

              # Redis
              REDIS_PASSWORD="${{ secrets.PROD_REDIS_PASSWORD }}"

              # JWT
              JWT_EXPIRATION="${{ secrets.PROD_JWT_EXPIRATION }}"
              JWT_REFRESH_EXPIRATION="${{ secrets.PROD_JWT_REFRESH_EXPIRATION }}"
              JWT_PRIVATE_KEY_PATH="${{ secrets.PROD_JWT_PRIVATE_KEY_PATH }}"
              JWT_PUBLIC_KEY_PATH="${{ secrets.PROD_JWT_PUBLIC_KEY_PATH }}"

              # OAuth
              KAKAO_CLIENT_ID="${{ secrets.PROD_KAKAO_CLIENT_ID }}"
              KAKAO_CLIENT_SECRET="${{ secrets.PROD_KAKAO_CLIENT_SECRET }}"
              KAKAO_REDIRECT_URI="${{ secrets.PROD_KAKAO_REDIRECT_URI }}"
              GOOGLE_CLIENT_ID="${{ secrets.PROD_GOOGLE_CLIENT_ID }}"
              GOOGLE_CLIENT_SECRET="${{ secrets.PROD_GOOGLE_CLIENT_SECRET }}"
              GOOGLE_REDIRECT_URI="${{ secrets.PROD_GOOGLE_REDIRECT_URI }}"

              # Holiday API
              HOLIDAY_API_KEY="${{ secrets.PROD_HOLIDAY_API_KEY }}"
              HOLIDAY_API_BASE_URL="${{ secrets.PROD_HOLIDAY_API_BASE_URL }}"

              # AWS
              AWS_REGION="${{ secrets.PROD_AWS_REGION }}"
              AWS_S3_BUCKET="${{ secrets.PROD_AWS_S3_BUCKET }}"
              AWS_S3_PUBLIC_BASE_URL="${{ secrets.PROD_AWS_S3_PUBLIC_BASE_URL }}"
              AWS_S3_UPLOAD_PREFIX="${{ secrets.PROD_AWS_S3_UPLOAD_PREFIX }}"

              # Firebase
              FIREBASE_CONFIG_PATH="${{ secrets.PROD_FIREBASE_CONFIG_PATH }}"

              # Server
              PORT="${{ secrets.PROD_PORT }}"
            else
              # Í∞úÎ∞úÍ≥ÑÎäî Í∏∞Ï°¥ ÏãúÌÅ¨Î¶ø ÏÇ¨Ïö©
              PRIVATE_EC2_HOST="${{ secrets.PRIVATE_EC2_HOST }}"
              PRIVATE_EC2_USER="${{ secrets.PRIVATE_EC2_USER }}"

              # MongoDB
              SPRING_DATA_MONGODB_URI="${{ secrets.SPRING_DATA_MONGODB_URI }}"
              MONGODB_ROOT_PASSWORD="${{ secrets.MONGODB_ROOT_PASSWORD }}"

              # Redis
              REDIS_PASSWORD="${{ secrets.REDIS_PASSWORD }}"

              # JWT
              JWT_EXPIRATION="${{ secrets.JWT_EXPIRATION }}"
              JWT_REFRESH_EXPIRATION="${{ secrets.JWT_REFRESH_EXPIRATION }}"
              JWT_PRIVATE_KEY_PATH="${{ secrets.JWT_PRIVATE_KEY_PATH }}"
              JWT_PUBLIC_KEY_PATH="${{ secrets.JWT_PUBLIC_KEY_PATH }}"

              # OAuth
              KAKAO_CLIENT_ID="${{ secrets.KAKAO_CLIENT_ID }}"
              KAKAO_CLIENT_SECRET="${{ secrets.KAKAO_CLIENT_SECRET }}"
              KAKAO_REDIRECT_URI="${{ secrets.KAKAO_REDIRECT_URI }}"
              GOOGLE_CLIENT_ID="${{ secrets.GOOGLE_CLIENT_ID }}"
              GOOGLE_CLIENT_SECRET="${{ secrets.GOOGLE_CLIENT_SECRET }}"
              GOOGLE_REDIRECT_URI="${{ secrets.GOOGLE_REDIRECT_URI }}"

              # Holiday API
              HOLIDAY_API_KEY="${{ secrets.HOLIDAY_API_KEY }}"
              HOLIDAY_API_BASE_URL="${{ secrets.HOLIDAY_API_BASE_URL }}"

              # AWS
              AWS_REGION="${{ secrets.AWS_REGION }}"
              AWS_S3_BUCKET="${{ secrets.AWS_S3_BUCKET }}"
              AWS_S3_PUBLIC_BASE_URL="${{ secrets.AWS_S3_PUBLIC_BASE_URL }}"
              AWS_S3_UPLOAD_PREFIX="${{ secrets.AWS_S3_UPLOAD_PREFIX }}"

              # Firebase
              FIREBASE_CONFIG_PATH="${{ secrets.FIREBASE_CONFIG_PATH }}"

              # Server
              PORT="${{ secrets.PORT }}"
            fi

            # ÌôòÍ≤ΩÎ≥Ñ SSH ÌÇ§ ÌååÏùºÎ™Ö ÏÑ§Ï†ï
            if [[ "${{ env.ENVIRONMENT }}" == "production" ]]; then
              PRIVATE_EC2_KEY="~/.ssh/weave-prd-private-key.pem"
            else
              PRIVATE_EC2_KEY="~/.ssh/weave-dev-private-key.pem"
            fi

            # Private EC2 SSH ÌÇ§Î•º Bastion HostÎ°ú Ï†ÑÏÜ°ÌïòÍ≥† Í∂åÌïú ÏÑ§Ï†ï
            echo "${{ env.ENVIRONMENT == 'production' && secrets.PROD_PRIVATE_EC2_SSH_KEY || secrets.PRIVATE_EC2_SSH_KEY }}" > ~/.ssh/weave-private-key.pem
            chmod 600 ~/.ssh/weave-private-key.pem

            # Î∞∞Ìè¨ ÌååÏùºÎì§ÏùÑ ÌîÑÎùºÏù¥Îπó EC2Î°ú Ï†ÑÏÜ°
            scp -o StrictHostKeyChecking=no -i ~/.ssh/weave-private-key.pem \
              ~/deployment/docker-compose.yml \
              ~/deployment/.env \
              ~/deployment/deploy.sh \
              ${PRIVATE_EC2_USER}@${PRIVATE_EC2_HOST}:~/

            # ÌîÑÎùºÏù¥Îπó EC2ÏóêÏÑú Î∞∞Ìè¨ Ïã§Ìñâ
            ssh -o StrictHostKeyChecking=no -i ~/.ssh/weave-private-key.pem \
              ${PRIVATE_EC2_USER}@${PRIVATE_EC2_HOST} \
              "export ECR_REGISTRY=${{ env.ECR_REGISTRY }} && \
               export IMAGE_TAG=${{ github.sha }} && \
               export SPRING_DATA_MONGODB_URI=${SPRING_DATA_MONGODB_URI} && \
               export MONGODB_ROOT_PASSWORD=${MONGODB_ROOT_PASSWORD} && \
               export REDIS_PASSWORD=${REDIS_PASSWORD} && \
               export JWT_EXPIRATION=${JWT_EXPIRATION} && \
               export JWT_REFRESH_EXPIRATION=${JWT_REFRESH_EXPIRATION} && \
               export JWT_PRIVATE_KEY_PATH=${JWT_PRIVATE_KEY_PATH} && \
               export JWT_PUBLIC_KEY_PATH=${JWT_PUBLIC_KEY_PATH} && \
               export KAKAO_CLIENT_ID=${KAKAO_CLIENT_ID} && \
               export KAKAO_CLIENT_SECRET=${KAKAO_CLIENT_SECRET} && \
               export KAKAO_REDIRECT_URI=${KAKAO_REDIRECT_URI} && \
               export GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID} && \
               export GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET} && \
               export GOOGLE_REDIRECT_URI=${GOOGLE_REDIRECT_URI} && \
               export HOLIDAY_API_KEY=${HOLIDAY_API_KEY} && \
               export HOLIDAY_API_BASE_URL=${HOLIDAY_API_BASE_URL} && \
               export AWS_REGION=${AWS_REGION} && \
               export AWS_S3_BUCKET=${AWS_S3_BUCKET} && \
               export AWS_S3_PUBLIC_BASE_URL=${AWS_S3_PUBLIC_BASE_URL} && \
               export AWS_S3_UPLOAD_PREFIX=${AWS_S3_UPLOAD_PREFIX} && \
               export FIREBASE_CONFIG_PATH=${FIREBASE_CONFIG_PATH} && \
               export PORT=${PORT} && \
               chmod +x ~/deploy.sh && \
               ~/deploy.sh"
